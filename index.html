<!DOCTYPE html>
<!--?xml version="1.0"?-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!--meta name="viewport" content="width=device-width, height=device-height, initial-scale = 0.5, maximum-scale = 0.5" /-->
    <meta name="viewport" content="initial-scale = 0.5, maximum-scale = 0.5, minimum-scale = 0.5, user-scalable=no" />
    <title>E-Fun</title>
        <style media="screen">
        html, body
        {
            overflow: hidden;
            height: 100%;
            width: 100%;
            margin-top: 0px;
            margin-left: 0px;
            touch-action: none;
            pointer-events: auto;
            background-color: gray;
        }
        .center {
            position: absolute;
            top: 50%;
            width: 100%;
            text-align: center;
        }
        
        a, a.exHover:visited, a.exHover:link {cursor: pointer; color: lightgray; text-decoration:none; border:0px solid #4466DD;}
        a.exHover:hover {cursor: pointer; color:white; text-decoration:none; border:0px solid #6699FF;}
        a.exHover:active {cursor: pointer; color:white; text-decoration:none; border:0px solid #DDDDFF;}

        a, img, div {
          -webkit-user-select: none; /* Safari 3.1+ */
          -moz-user-select: none; /* Firefox 2+ */
          -ms-user-select: none; /* IE 10+ */
          user-select: none; /* Standard syntax */
        }

    </style>
    <body>
        <!--div id="splash" class="center" style="visibility: visible; font-family: Arial, Helvetica, sans-serif; color: rgb(255, 255, 255); height: 50%;"-->
        <div id="splash" class="center" style="visibility: visible; font-family: Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(255, 255, 255);">
            ...computing bitmaps...
        </div>
        <div id="heading1" align="center" style="background-color: rgb(48, 48, 48); color: rgb(208, 208, 208); visibility: hidden; position: absolute; top: 0px; right: 0px; left: 0px; font-family: Arial, Helvetica, sans-serif; font-size: 48px; font-weight: bold;">
            <heading1>
                E-Fun
            </heading1>
        </div>
        <div id="divContainer" style="position: absolute; top: 58px; bottom: 10px; left: 10px; right: 10px;">
        </div>
        <img id="i1" src="media/i1.svg" style="visibility: hidden; position: absolute; opacity: 1;">
        <img id="i2" src="media/i2.svg" style="visibility: hidden; position: absolute; opacity: 1;">
        <img id="i3" src="media/i3.svg" style="visibility: hidden; position: absolute; opacity: 1;">
        <!--script src="commonmark.min.js"></script-->
        <script src="orbital.js"></script>
        <script>
            /*
            function generateCanvasScape (r, index) {
                if (!r) r = 0;
                if (!index) index = 0;
                
                var data = {
                    canvas: generateNumberCanvas (r + " - " + index),
                    children: []
                };
                
                if (r < 2)
                    for (var i = 0; i < 5; i++)
                        data.children.push (generateCanvasScape (r + 1, i));
                
                return data;
            }
            */
            /*
            function toggleFullScreen() {
              var doc = window.document;
              var docEl = doc.documentElement;

              var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
              var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

              if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                requestFullScreen.call(docEl);
              }
              else {
                cancelFullScreen.call(doc);
              }
            }
            */

            function setSize () {
                var ratio = 1;// / 1.61803398875;
                
                var w = document.body.clientWidth;
                var h = document.body.clientHeight;
                
                var fs = Math.floor (h / 1080 * 48);
                document.getElementById("heading1").style.fontSize = fs + "px";

                i1.draggable = false;
                i1.ondragstart = function () {return false};
                i2.draggable = false;
                i2.ondragstart = function () {return false};
                i3.draggable = false;
                i3.ondragstart = function () {return false};
                
                if (w >= h) {
                    var m = (document.body.clientHeight - 58) / 950;
                    var ratioX = ratio;
                    var ratioY = 1;

                } else {
                    var m = document.body.clientWidth / 950;
                    var ratioX = 1;
                    var ratioY = ratio;

                }
                
                if (m > 0.7) m = 0.7;
                if (m < 0) m = 0;
                
                i1.style.width = m * 215 + "px";
                i2.style.width = m * 215 + "px";
                i3.style.width = m * 215 + "px";

                /*
                i1.style.transform = "";
                i2.style.transform = "";
                i3.style.transform = "";
                */

                i1.style.transform = " scale(" +
                  ratioX + ", " +
                  ratioY +
                  ")";
                i2.style.transform = " scale(" +
                  ratioX + ", " +
                  ratioY +
                  ")";
                i3.style.transform = " scale(" +
                  ratioX + ", " +
                  ratioY +
                  ")";

                if (w >= h) {
                    var gap = (h - i1.clientHeight - i2.clientHeight - i3.clientHeight - fs - 10) / 4;
                    if (gap < 1) gap = 1;

                    i1.style.top = fs + gap + "px";
                    i1.style.left = 10 + "px";
                    i2.style.top = fs + gap + i1.clientHeight + gap + "px";
                    i2.style.left = 10 + "px";
                    i3.style.top = fs + gap + i1.clientHeight + gap + i2.clientHeight + gap + "px";
                    i3.style.left = 10 + "px";
                    
                    divContainer.style.left = 20 + i1.clientWidth + "px";
                    divContainer.style.top = (fs + 20) + "px";
                } else {
                    var gap = (w - i1.clientWidth - i2.clientWidth - i3.clientWidth) / 4;
                    if (gap < 1) gap = 1;
                    
                    i1.style.left = gap + "px";
                    i1.style.top = fs + 10 + 10 + "px";
                    i2.style.left = gap + i1.clientWidth + gap + "px";
                    i2.style.top = fs + 10 + 10 + "px";
                    i3.style.left = gap + i1.clientWidth + gap + i2.clientWidth + gap + "px";
                    i3.style.top = fs + 10 + 10 + "px";
                    
                    divContainer.style.left = "10px";
                    divContainer.style.top = (fs + 10 + 20 + i1.clientHeight) + "px";
                }
                
                var event1 = new CustomEvent('resize1', null);
                divContainer.dispatchEvent(event1);
            }
            
            var i1 = document.getElementById("i1");
            var i2 = document.getElementById("i2");
            var i3 = document.getElementById("i3");
            
            var wloaded = false;
            wonload = function () {
                if (!wloaded) {
                    wloaded = true;
                    document.getElementById("vis").onclick = (function () {
                        window.location.href = 'https://github.com/e-teoria/Orbiteque';
                    })
                    
                    document.getElementById("vis").ontouchstart = document.getElementById("vis").onclick;
                    
                    /*document
                    .querySelector("meta[name=viewport]")
                    .setAttribute('content', 'initial-scale=0.5', 'maximum-scale=0.5', 'width=' + (document.documentElement.clientWidth * 2), 'height=' + (document.documentElement.clientHeight * 2));
                    */
                    document.getElementById("splash").style.visibility = "hidden";
                    document.getElementById("heading1").style.visibility = "visible";
                    document.getElementById("vis").style.visibility = "visible";
                    i1.style.visibility = "visible";
                    i2.style.visibility = "visible";
                    i3.style.visibility = "visible";
                    divContainer.style.visibility = "visible";

                    setSize ();

                    var resizeId;
                    window.addEventListener('resize', function () {
                        /*document
                        .querySelector("meta[name=viewport]")
                        .setAttribute('content', 'user-scalable=no', 'width=' + (document.documentElement.clientWidth), 'height=' + (document.documentElement.clientHeight));
                        document.getElementById("splash").style.visibility = "visible";
                        */
                        //document.getElementById("splash").style.visibility = "visible";
                        document.getElementById("heading1").style.visibility = "hidden";
                        document.getElementById("vis").style.visibility = "hidden";
                        i1.style.visibility = "hidden";
                        i2.style.visibility = "hidden";
                        i3.style.visibility = "hidden";
                        divContainer.style.visibility = "hidden";
                        
                        clearTimeout(resizeId);
                        resizeId = setTimeout(function () {
                            //document.getElementById("splash").style.visibility = "hidden";
                            
                            document.getElementById("heading1").style.visibility = "visible";
                            document.getElementById("vis").style.visibility = "visible";
                            i1.style.visibility = "visible";
                            i2.style.visibility = "visible";
                            i3.style.visibility = "visible";
                            divContainer.style.visibility = "visible";

                            setSize ();
                        }, 500);
                    });
                }
            }

            function createCanvas (img, scale) {
                var cnvim = document.createElement ("canvas");
                cnvim.width = ~~(img.width * scale);
                cnvim.height = ~~(img.height * scale);
                var ctxim = cnvim.getContext ('2d');

                ctxim.fillStyle = "white";
                ctxim.fillRect(0, 0, cnvim.width, cnvim.height);
                
                //img.width = cnvim.width;
                //img.height = cnvim.height;

                ctxim.drawImage (img, 0, 0, cnvim.width, cnvim.height);

                return cnvim
            }            
            
            
            var loader = function (data, scale) {
                var images = [];

                (function loadImages (node) {
                    node.img = new Image ();
                    
                    node.img.crossOrigin = "anonymous";
                    
                    node.img.onload = function (e) {
                        node.canvas = createCanvas (node.img, scale);
                    }
                    
                    node.img.onerror = function (e) {
                        alert ('Error loading: "' + node.image + '"');
                    }

                    node.img.src = node.image;
                    images.push (node);

                    if (node.children)
                        for (var i = 0; i < node.children.length; i++)
                            loadImages (node.children[i]);
                })(data);
                
                return images;
            };
            
            function loadContents () {
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        data = JSON.parse (this.responseText);
                        
                        if (data["flat-area"])
                            try {
                                if (data["flat-area"].substr(data["flat-area"].length - 1, 1) !== "%")
                                    throw new error ();
                                
                                var flatArea = parseFloat (data["flat-area"].substr(0, data["flat-area"].length - 1));
                                if (flatArea < 0 || flatArea > 100)
                                    throw new error ();
                                
                            } catch (e) {
                                alert ('Error: "flat-area" hast to be a percent between "0%" and "100%"');
                                throw new error ();
                            }
                        else
                            flatArea = 0;

                        if (data["scale"])
                            try {
                                if (data["scale"].substr(data["scale"].length - 1, 1) !== "%")
                                    throw new error ();
                                
                                var scale = parseFloat (data["scale"].substr(0, data["scale"].length - 1));
                                if (scale <= 0)
                                    throw new error ();
                                
                            } catch (e) {
                                alert ('Error: "scale" hast to be a percent greater than "0%"');
                                throw new error ();
                            }
                        else
                            scale = 100;
                        
                        if (data["title"]) {
                            document.getElementById("heading1").innerHTML = data["title"];
                            document.getElementsByTagName("TITLE")[0].text = data["title"];
                        }
                        
                        var images = loader (data.data, scale / 100);
                        
                        var waitForImages = function () {
                            for (var i = 0; i < images.length; i++){
                                if (!images[i].canvas) {
                                    setTimeout(waitForImages, 0);
                                    return;
                                }                 
                            }
                            Orbital (divContainer, data.data, flatArea / 100);
                            window.addEventListener("load", wonload ());
                        }
                        
                        waitForImages ();
                            
                        
                    }
                
                };
                xhttp.open("GET", "contents.json", true);
                xhttp.send();
            }
            
            var divContainer = document.getElementById ("divContainer")
            //Orbital(divContainer, generateCanvasScape ());
            
            loadContents ();
            
            
        </script>
        <!--svg id="fs" onclick="toggleFullScreen ()" style="position: absolute; top: 0; right: 0;"
           xmlns:dc="http://purl.org/dc/elements/1.1/"
           xmlns:cc="http://creativecommons.org/ns#"
           xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
           xmlns:svg="http://www.w3.org/2000/svg"
           xmlns="http://www.w3.org/2000/svg"
           id="svg8"
           version="1.1"
           viewBox="0 0 14.552083 14.552084"
           height="55"
           width="55">
          <defs
             id="defs2" />
          <metadata
             id="metadata5">
            <rdf:RDF>
              <cc:Work
                 rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type
                   rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                <dc:title></dc:title>
              </cc:Work>
            </rdf:RDF>
          </metadata>
          <g
             transform="translate(0,-282.4479)"
             id="layer1">
            <path
               id="path833"
               d="m 3.2248744,288.37355 v -2.70078 h 2.7007782"
               style="fill:none;stroke:rgb(255, 255, 255);stroke-width:0.52916667;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
            <path
               id="path835"
               d="m 8.6381733,285.67277 h 2.6890357 v 2.70078"
               style="fill:none;stroke:rgb(255, 255, 255);stroke-width:0.52916667;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
            <path
               id="path837"
               d="m 11.327209,291.07433 v 2.70078 H 8.6381733"
               style="fill:none;stroke:rgb(255, 255, 255);stroke-width:0.52916667;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
            <path
               id="path839"
               d="M 5.9256526,293.77511 H 3.2248744 v -2.70078"
               style="fill:none;stroke:rgb(255, 255, 255);stroke-width:0.52916667;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
          </g>
        </svg-->
        <!--a id="vis" class="exhover" style="visibility: hidden; position: absolute; bottom: 0px; right: 5px; clip-path: circle(40% at 50% 50%);">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="" style="width:96px; height:96px; padding-top: 3px; padding-left: 4px; padding-right: 4px; padding-bottom: 0px;">
        </a-->
        <a id="vis" class="exHover" style="visibility: hidden; position: absolute; bottom: 5px; right: 5px; font-family: Arial, Helvetica, sans-serif; font-size: 8pt;">
          powered by e-fun
        </a>
    </body>
</html>
